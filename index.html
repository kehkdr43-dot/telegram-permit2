<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>USDC Sepolia ‚Äì Permit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body style="font-family: Arial; padding: 20px;">
  <h2>Signer un transfert USDC (Sepolia)</h2>

  <p>
    Montant : <strong>10 USDC</strong><br />
    R√©seau : <strong>Sepolia</strong><br />
    Gas pay√© par : <strong>Wallet B</strong>
  </p>

  <button id="sign" style="font-size:18px; padding:10px;">
    Signer
  </button>

  <p id="status"></p>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.10.0/+esm";

    /**************** CONFIG ****************/
    const SERVER_URL =
      "https://arya-unenamoured-refractorily.ngrok-free.dev/signature";

    const WALLET_B_ADDRESS = "0xF6BeD72aA6eB2e0DBb2768F07ed77f1c5dCEC6b1"; // ‚¨ÖÔ∏è √Ä REMPLACER

    /*************** USDC SEPOLIA ***************/
    const TOKEN_ADDRESS = "0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238";
    const TOKEN_NAME = "USD Coin";
    const TOKEN_VERSION = "1";
    const DECIMALS = 6;
    const CHAIN_ID = 11155111;
    const CHAIN_ID_HEX = "0xaa36a7";
    const AMOUNT = "10";

    const status = document.getElementById("status");

    document.getElementById("sign").onclick = async () => {
      try {
        if (!window.ethereum) {
          alert("Ouvre ce site dans MetaMask");
          return;
        }

        status.innerText = "Connexion √† MetaMask‚Ä¶";

        // ‚úÖ UN SEUL PROVIDER (IMPORTANT)
        const provider = new ethers.BrowserProvider(window.ethereum);

        // üîí Forcer Sepolia
        const network = await provider.getNetwork();
        if (network.chainId !== BigInt(CHAIN_ID)) {
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: CHAIN_ID_HEX }]
          });
        }

        // ‚è≥ laisser MetaMask se synchroniser
        await new Promise(r => setTimeout(r, 500));

        const signer = await provider.getSigner();
        const owner = await signer.getAddress();

        // üîé V√©rifier que le contrat existe
        const code = await provider.getCode(TOKEN_ADDRESS);
        if (code === "0x") {
          throw new Error("USDC introuvable sur ce r√©seau");
        }

        // üî¢ Lire le nonce AVEC LE M√äME PROVIDER
        const token = new ethers.Contract(
          TOKEN_ADDRESS,
          ["function nonces(address) view returns (uint256)"],
          provider
        );

        const nonce = await token.nonces(owner);
        console.log("Nonce OK :", nonce.toString());

        const value = ethers.parseUnits(AMOUNT, DECIMALS);
        const deadline = Math.floor(Date.now() / 1000) + 3600;

        // ‚úçÔ∏è PERMIT (EIP-2612)
        const domain = {
          name: TOKEN_NAME,
          version: TOKEN_VERSION,
          chainId: CHAIN_ID,
          verifyingContract: TOKEN_ADDRESS
        };

        const types = {
          Permit: [
            { name: "owner", type: "address" },
            { name: "spender", type: "address" },
            { name: "value", type: "uint256" },
            { name: "nonce", type: "uint256" },
            { name: "deadline", type: "uint256" }
          ]
        };

        const message = {
          owner,
          spender: WALLET_B_ADDRESS,
          value,
          nonce,
          deadline
        };

        status.innerText = "Signature en cours‚Ä¶";

        const signature = await signer.signTypedData(
          domain,
          types,
          message
        );

        const { v, r, s } = ethers.Signature.from(signature);

        status.innerText = "Envoi de la signature‚Ä¶";

        await fetch(SERVER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            owner,
            value: value.toString(),
            deadline,
            v,
            r,
            s
          })
        });

        status.innerText = "‚úÖ Signature envoy√©e";

      } catch (err) {
        console.error(err);
        status.innerText = "‚ùå Erreur : " + err.message;
      }
    };
  </script>
</body>
</html>


